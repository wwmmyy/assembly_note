# 第一个程序

## 4.1 从源程序写出到执行的过程

1. 写出汇编源程序  
就是一个文本文件
2. 编译和连接
用汇编编译器对源码进行编译,生成目标文件  
用连接程序对目标文件进行连接,生成操作系统可以执行的可执行文件
3. 执行程序

### 可执行文件包含两部分

+ 程序(从汇编翻译过来的机器码)和数据(源程序中定义的数据)
+ 描述信息(程序有多大,需要占用多大内存等信息)

## 4.2 源程序

```assembly
assume cs:codesg

codesg segment
    mov ax,0123H
    mov bx,0456H
    add ax,bx
    add ax,ax

    mov ax,4c00H
    int 21H
codesg ends

end
```

汇编源程序中,包含伪指令(给编译器看的)和汇编指令(会被翻译成机器码)

上面的源程序中,segment 和ends是一对伪指令,定义了一个叫codesg的段  
使用;作为注释(类似常用的//)  
一个汇编源程序由多个段组成,这些段用来存放代码,或者当作数据和栈空间  
end(区别于ends)是一个结束标记,这个伪指令告诉编译器在这里结束  
assume意为假设,他假设某一个段寄存器和程序中的某个用segment...ends定义的段相关联  
一个程序结束后,将CPU的控制权交还给使得它运行的程序,这个过程称之为:**程序返回**  
mov ax,4c00H和int 21H实现程序返回

## 4.3 编辑源程序

使用Edit编辑文本文件

## 4.4 编译

本书采用masm5.0汇编编译器  

masm生成obj目标文件

## 4.5 连接

对目标文件进行连接,生成可执行文件  

采用Overlay Linker3.6连接器  

link根据目标文件生成可执行文件

## 4.6 以简化的方式j进行编译和连接

在nasm和link后边加上分号;可以忽略中间生成,只得到输出结果

## 4.7 执行

在DOS下,输入exe文件的名字就可以执行程序

## 4.8 谁将可执行文件中的程序装载进内存并使它运行的

### 操作系统的外壳(shell)

DOS中有一个叫command.com的程序,我们称之为命令解释器,也就是DOS的shell  
DOS启动时,完成初始化工作之后,会运行command.com,屏幕上就显示命令提示符了,等待用户输入  
用户输入的比如cd,dir,type这些命令,都是由command执行,执行完之后,再次返回command,显示命令提示符继续接受用户输入

DOS中执行example.exe时,正在运行的command.com将example.exe中的程序装入内存,command设置CPU的CS:IP指向程序的第一条指令,然后运行example.exe  
程序结束之后,返回到command中,CPU继续运行command  

## 4.9 程序执行过程的跟踪

可以使用Debug来追踪一个程序的运行  
这个程序由Debug来执行,程序在执行的过程中,Debug并不放弃CPU的控制权(区别于command.com),使我们得以查看某个时刻CPU的状态

### DOS中exe文件的加载过程

1. 找到一段起始地址为SA:0000(偏移地址为0)的容量足够的空闲内存
2. 在这段内存中,前256个字节中,创建一个称之为**程序段前缀**(PSP)的数据区,DOS利用PSP来和被加载的程序通信
3. 在PSP之后,将程序装入(地址是SA+10H:0)
4. 程序的段地址存入DS寄存器,初始化其他寄存器之后,将CS:IP指向入口  
CS的内容是SA+10,DS为SA

debug example.exe即可调试  
cx中存放了程序的长度  
程序被装载在DS:0处  
CS比DS大10H,因为程序的开头是256字节的PSP  
debug中默认所有数据都是十六进制  
使用p(不是t)命令执行完int 21H之后,显示"Program terminated normally",返回到debug中,程序正常结束  
使用q命令退出debug
